name: All in one build

on:
  pull_request:

permissions:
  contents: write
  packages: write

jobs:

  core:
    uses: ./.github/workflows/core.yml
    with:
      node_version: '18'
      buf_version: 'latest'
      go_version: '1.20'
    
  console:
    uses: ./.github/workflows/console.yml
    with:
      node_version: '18'
      buf_version: 'latest'

  compile:
    needs: [core, console]
    uses: ./.github/workflows/compile.yml
    with:
      go_version: '1.20'
      core_cache_key: ${{ needs.core.outputs.cache_key }}
      console_cache_key: ${{ needs.console.outputs.cache_key }}
      core_cache_path: ${{ needs.core.outputs.cache_path }}
      console_cache_path: ${{ needs.console.outputs.cache_path }}

  core-unit-test:
    # if: ${{ needs.core.outputs.cache_hit != 'true' }}
    needs: core
    uses: ./.github/workflows/core-unit-test.yml
    with:
      go_version: '1.20'
      core_cache_key: ${{ needs.core.outputs.cache_key }}
      core_cache_path: ${{ needs.core.outputs.cache_path }}
      
  core-integration-test:
    # if: ${{ needs.core.outputs.cache_hit != 'true' }}
    needs: core
    uses: ./.github/workflows/core-integration-test.yml
    with:
      go_version: '1.20'
      core_cache_key: ${{ needs.core.outputs.cache_key }}
      core_cache_path: ${{ needs.core.outputs.cache_path }}
  
  lint:
    needs: [core, console]
    uses: ./.github/workflows/lint.yml
    with:
      go_version: '1.20'
      node_version: '18'
      buf_version: 'latest'
      core_cache_key: ${{ needs.core.outputs.cache_key }}
      core_cache_path: ${{ needs.core.outputs.cache_path }}
      core_cache_hit: ${{ needs.core.outputs.cache_hit }}
      console_cache_hit: ${{ needs.console.outputs.cache_hit }}






  # e2e:
  #   uses: ./.github/workflows/e2e.yml
  #   needs: [container]
  #   with:
  #     tag_name: ghcr.io/zitadel/test:${{ github.sha }}


  #release